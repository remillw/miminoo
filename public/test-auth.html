<!doctype html>
<html>
    <head>
        <title>Test Auth</title>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    </head>
    <body>
        <h1>Test d'authentification</h1>
        <button onclick="testAuth()">Tester /debug-auth</button>
        <button onclick="testBroadcastAuth()">Tester /broadcasting/auth</button>
        <div id="results"></div>

        <script>
            function getCsrfToken() {
                // Simuler la récupération du token CSRF comme dans votre app
                return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 'NO_TOKEN';
            }

            function testAuth() {
                console.log('🧪 Test /debug-auth...');

                axios
                    .post(
                        '/debug-auth',
                        {},
                        {
                            withCredentials: true,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                                'X-CSRF-TOKEN': getCsrfToken(),
                                Accept: 'application/json',
                                'Content-Type': 'application/json',
                            },
                        },
                    )
                    .then((res) => {
                        console.log('🧪 Response status:', res.status);
                        console.log('🧪 Response data:', res.data);

                        if (res.data.auth_user) {
                            console.log('🧪 ✅ AUTH SUCCESS:', !!res.data.auth_user);
                            console.log('🧪 User:', res.data.auth_user.email);
                        } else {
                            console.log('🧪 ❌ AUTH FAILED: No user found');
                        }

                        document.getElementById('results').innerHTML = '<pre>' + JSON.stringify(res.data, null, 2) + '</pre>';
                    })
                    .catch((err) => {
                        console.error('🧪 ❌ Error:', err);
                        console.error('🧪 Status:', err.response?.status);
                        console.error('🧪 Data:', err.response?.data);
                        document.getElementById('results').innerHTML =
                            '<pre style="color: red;">ERROR: ' + JSON.stringify(err.response?.data, null, 2) + '</pre>';
                    });
            }

            function testBroadcastAuth() {
                console.log('🧪 Test /broadcasting/auth...');

                axios
                    .post(
                        '/broadcasting/auth',
                        {
                            channel_name: 'private-conversation.1',
                            socket_id: '123.456',
                        },
                        {
                            withCredentials: true,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                                'X-CSRF-TOKEN': getCsrfToken(),
                                Accept: 'application/json',
                                'Content-Type': 'application/json',
                            },
                        },
                    )
                    .then((res) => {
                        console.log('🧪 Broadcast auth SUCCESS:', res.data);
                        document.getElementById('results').innerHTML =
                            '<pre style="color: green;">BROADCAST AUTH SUCCESS: ' + JSON.stringify(res.data, null, 2) + '</pre>';
                    })
                    .catch((err) => {
                        console.error('🧪 Broadcast auth ERROR:', err);
                        document.getElementById('results').innerHTML =
                            '<pre style="color: red;">BROADCAST AUTH ERROR: ' + JSON.stringify(err.response?.data, null, 2) + '</pre>';
                    });
            }
        </script>
    </body>
</html>
