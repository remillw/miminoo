<template>
    <div class="flex w-full max-w-md flex-col gap-4 rounded-3xl bg-white p-4 shadow-md sm:p-6">
        <!-- Header: Avatar + Name + Rating optimis√© mobile -->
        <div class="flex items-center gap-3 sm:gap-4">
            <img :src="avatar" alt="Avatar" class="h-12 w-12 rounded-full object-cover sm:h-14 sm:w-14" />
            <div class="min-w-0 flex-1">
                <div class="truncate text-base font-bold sm:text-lg">{{ name }}</div>

                <!-- N'afficher les avis que s'il y en a -->
                <div v-if="rating && reviews > 0" class="flex items-center gap-1 text-sm text-gray-400">
                    <Star class="h-4 w-4 fill-current text-yellow-400" />
                    <span class="font-semibold text-gray-700">{{ rating }}</span>
                    <span class="text-gray-400">({{ reviews }} avis)</span>
                </div>
            </div>
        </div>

        <!-- Date, time, location optimis√© mobile -->
        <div class="grid grid-cols-1 gap-3 text-sm sm:grid-cols-2 sm:gap-4">
            <div class="flex items-start gap-2">
                <CalendarClock class="text-primary bg-secondary h-6 w-6 rounded-md p-1 sm:h-7 sm:w-7" />
                <div class="min-w-0 flex-1">
                    <p class="font-semibold">{{ date }}</p>
                    <p class="text-gray-400">{{ time }}</p>
                </div>
            </div>
            <div class="flex items-start gap-2">
                <MapPin class="text-primary bg-secondary h-6 w-6 rounded-md p-1 sm:h-7 sm:w-7" />
                <div class="min-w-0 flex-1">
                    <p class="font-semibold">
                        <span class="block truncate">{{ city }}</span>
                        <span class="text-gray-500">{{ postalCode }}</span>
                    </p>
                    <!-- Affichage de la distance si disponible -->
                    <p v-if="distance !== null" class="flex items-center gap-1 text-xs text-gray-500">
                        <span>üìç {{ distance }} km</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Kids optimis√© mobile -->
        <div class="flex items-center gap-2 text-sm">
            <Users class="text-primary bg-secondary h-6 w-6 rounded-md p-1 sm:h-7 sm:w-7" />
            <p class="min-w-0 flex-1 truncate font-semibold">{{ childrenLabel }}</p>
        </div>

        <!-- Description optimis√©e mobile -->
        <p v-if="description" class="line-clamp-2 text-sm text-gray-800 sm:line-clamp-3">
            {{ description }}
        </p>

        <!-- Footer optimis√© mobile -->
        <div class="flex items-center justify-between gap-3 border-t border-gray-200 pt-2 sm:pt-3">
            <div class="min-w-0 flex-1">
                <span class="text-lg font-bold sm:text-xl">{{ rate }}‚Ç¨</span>
                <span class="text-gray-400">/heure</span>
            </div>

            <!-- Boutons selon le statut de candidature -->
            <!-- Bouton pour postuler ou repostuler -->
            <button
                v-if="!isOwnAnnouncement && canApply"
                @click="isModalOpen = true"
                class="bg-primary hover:bg-primary cursor-pointer rounded px-4 py-2 text-sm font-semibold text-white transition-colors sm:px-5"
            >
                {{ userApplicationStatus === 'cancelled' ? 'Repostuler' : 'Postuler' }}
            </button>

            <!-- Message si d√©j√† postul√© (non annul√©) -->
            <div
                v-else-if="!isOwnAnnouncement && userApplicationStatus && userApplicationStatus !== 'cancelled'"
                class="rounded bg-gray-100 px-3 py-2 text-center text-xs font-medium text-gray-600"
            >
                <div v-if="userApplicationStatus === 'pending'">En attente</div>
                <div v-else-if="userApplicationStatus === 'accepted'">Accept√©e</div>
                <div v-else-if="userApplicationStatus === 'declined'">Refus√©e</div>
                <div v-else-if="userApplicationStatus === 'counter_offered'">Contre-offre</div>
                <div v-else>Postul√©</div>
            </div>

            <!-- Message si annonce pleine ou ne peut pas postuler -->
            <div
                v-else-if="!isOwnAnnouncement && !canApply && !userApplicationStatus"
                class="cursor-not-allowed rounded bg-gray-300 px-3 py-2 text-sm font-medium text-gray-600"
                title="Cette annonce n'est plus disponible"
            >
                Indisponible
            </div>

            <!-- Message si c'est sa propre annonce -->
            <div v-else-if="isOwnAnnouncement" class="rounded bg-gray-100 px-3 py-2 text-sm font-medium text-gray-500">Votre annonce</div>
        </div>

        <!-- Modal de candidature -->
        <PostulerModal
            :is-open="isModalOpen"
            :on-close="() => (isModalOpen = false)"
            :announcement-id="id"
            :date="rawDate"
            :hours="time"
            :location="`${city}, ${postalCode}`"
            :children-count="childrenCount"
            :avatar-url="avatar"
            :family-name="name"
            :requested-rate="rate"
            :additional-info="additionalInfo"
            :existing-application="existingApplication"
            :start-time="startTime"
            :end-time="endTime"
        />
    </div>
</template>

<script setup lang="ts">
import { usePage } from '@inertiajs/vue3';
import { CalendarClock, MapPin, Star, Users } from 'lucide-vue-next';
import { computed, ref } from 'vue';
import PostulerModal from './PostulerModal.vue';

const props = defineProps({
    id: {
        type: Number,
        required: true,
    },
    parentId: {
        type: Number,
        required: true,
    },
    avatar: {
        type: String,
        required: true,
    },
    name: {
        type: String,
        required: true,
    },
    rating: {
        type: [Number, null],
        default: null,
    },
    reviews: {
        type: Number,
        default: 0,
    },
    date: {
        type: String,
        required: true,
    },
    rawDate: {
        type: String,
        required: true,
    },
    time: {
        type: String,
        required: true,
    },
    startTime: {
        type: String,
        required: true,
    },
    endTime: {
        type: String,
        required: true,
    },
    postalCode: {
        type: String,
        required: true,
    },
    city: {
        type: String,
        required: true,
    },
    childrenLabel: {
        type: String,
        required: true,
    },
    childrenCount: {
        type: Number,
        required: true,
    },
    description: {
        type: String,
        default: '',
    },
    rate: {
        type: Number,
        required: true,
    },
    distance: {
        type: Number,
        default: null,
    },
    latitude: {
        type: Number,
        required: true,
    },
    longitude: {
        type: Number,
        required: true,
    },
    additionalInfo: {
        type: String,
        default: null,
    },
    isMultiDay: {
        type: Boolean,
        default: false,
    },
    applicationsCount: {
        type: Number,
        default: 0,
    },
    canApply: {
        type: Boolean,
        default: true,
    },
    userApplicationStatus: {
        type: String,
        default: null,
    },
    existingApplication: {
        type: Object,
        default: null,
    },
});

const isModalOpen = ref(false);

// Acc√®s √† l'utilisateur connect√©
const page = usePage();
const user = computed(() => (page.props as any).auth?.user);

// V√©rifier si c'est la propre annonce de l'utilisateur
const isOwnAnnouncement = computed(() => {
    return user.value && props.parentId === user.value.id;
});
</script>

<style scoped>
/* Classes utilitaires pour line-clamp */
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>
